---
title: "Assignment 2"
author: ~~Hari Subhash~~ Mario 
date: "Date created: `r Sys.Date()`"
output:
  html_notebook:
    highlight: kate
    smart: yes
    theme: cosmo
    code_folding: show
    df_print: paged
    toc: true
    toc_depth: 2
---

## Abstract

Unpredictable flight delays are a costly problem, forcing travelers to choose between spending extra time at the airport and missing a flight. In 2013, flights from the three New York area airports alone saw aggregate delays of half a million minutes. I explore the predictive capacity with respect to departure delay of five variables that are forecasted ahead of time and publicly available.

## Background

**PROBLEM:** Here, the problem is that flight delays are unpredictable. Not only that, mis-timing your ride to the airport could be costly; Arrive late and you may miss your flight altogether, but arrive early and you'll spend even more uncomfortable, unproductive time at the gate

**GOAL:** My ultimate goal is to be able to best predict a flight's departure delay. In an ideal world, all flights would simply leave on time. In a second-best world, each airline would contact travelers directly with flight delay information that was accurate and timely enough to be actionable. Alas, neither of those are the case and so in the world we live in, my goal is to better predict delay using weather and flight data.

**HYPOTHESIS:** My null hypothesis is that *no* available weather or flight data shares a relationship with flight delay. 


## Setting up

To set up, I'll do the following:

1. Install and enable the packages that will help explore, manipulate, and analyze the data
2. Join flight data with corresponding weather data 
3. Set negative departure delay values equal to zero because flights that leave before their scheduled departure time are not "more" on time than flights that leave at exactly their scheduled time (N.B. I will leave entries with n/a values for )

```{r}
### Install packages, as needed 
# install.packages('tidyverse') 
# install.packages('skimr') 
# install.package('lubridate')
# install.packages('ggthemes')

# This line enables relevant packages
library(tidyverse); library(skimr); library(nycflights13); library(lubridate); library(ggthemes)

### This joins flight and weather data, storing it in the new data frame we'll work with
flt_wx_raw <- flights %>%
  left_join(weather,by = c('origin','time_hour')) %>%
  mutate(dep_delay = (abs(dep_delay) + dep_delay) / 2) ## Here, I'm zeroing out negative delays
# 
flt_wx
```

## Univariate analysis

Here's what I'll look at for each variable:

* Metadata will explain what each variable represents
* Descriptive variables including number of observations, mean, standard deviation, median, min, max, and interquartile measures
* A histogram will offer a visual representation of each

Doing this will expose:

* Fields that would be unlikely related to departure delay,
* Fields that will require transformation, and
* Fields with too few observations or with too many missing observations to be representative

```{r}
skim(flt_wx_raw)
```
The following fields are either unlikely to be related to departure delay or duplicative of another, superior field in the data set

* Destination
* Tail number
* Arrival time
* Day of the month
* Flight number
* Scheduled arrival time
* Year
* Air time
* Arrival delay
* Departure time
* Distance

The following fields will need to be transformed in the succeeding ways:

* Departure delay -- replace negative values with 0
* Carrier -- Use difference between the mean delay of flights by a single carrier with mean delay overall
* Origin --  Use difference between the mean delay of flights that originate at a single airport with mean delay overall
* Time_hour -- Extract day of the week and convert to a dummy variable for whether the day is a weekend day
* Scheduled departure time -- Use difference with the hour of day of peak delays
* Month -- Use difference with the month of peak delays

Only one field among those remaining, **wind gust**, is concerning due to the number of n/a entries. My fear is that these incomplete entries are biased -- that is, we may be telling a story that is based on a sample of the data that does not represent the poopulation.
```{r}
flt_wx_raw %>%
  select(wind_gust,dep_delay) %>%
  filter(is.na(dep_delay) == F) %>%
  mutate(na_gust = if_else(is.na(wind_gust), 0, 1)) %>% 
  group_by(na_gust) %>% ## Here, I split up all entries based on whether or not wind_gust is NULL
  summarise(mean_del = mean(dep_delay,na.rm = T) ## Starting here, I look at descriptive statistics by NULL or not
     ,n_del     = length(dep_delay)
     ,mean_del   = mean(dep_delay,na.rm = T)         
     ,stdev_del  = sd(dep_delay,na.rm = T)
     ,min_del    = min(dep_delay,na.rm = T)
     ,del_25qile = quantile(dep_delay,probs = 0.25,na.rm = T)
     ,mdn_del    = median(dep_delay,na.rm = T)
     ,del_75qile = quantile(dep_delay,probs = 0.75,na.rm = T)
     ,max_del    = max(dep_delay, na.rm = T))
    round(2)

flt_wx_raw %>%
  select(wind_gust,dep_delay) %>%
  filter(is.na(dep_delay) == F) %>%
  mutate(na_gust = if_else(is.na(wind_gust), 0, 1)) %>%
  ggplot(aes(dep_delay)) +
  geom_density() +
  ggtitle(label = 'Dep. delay differs when wind gust is na but not by much') +
  theme_fivethirtyeight() +
  facet_wrap(~na_gust, nrow = 2, ncol = 1)
```
These look similar enough to work with. To verify with numbers, I would do a z-test to see if I'm able to disprove that the means are unequal and an f-test to do the same with the standard deviations. But not today. Today, I will do neither.

Now to filter out the unused fields and transform other fields:
```{r}
flt_wx_cln <- flt_wx_raw %>%
  group_by(carrier) %>%
  mutate(carr_delay = mean(dep_delay,na.rm = T) - mean(flights$dep_delay,na.rm = T) ## Creating the carrier effect
         ,is_wkend   = if_else(wday(as.Date(time_hour)) == 1
            | wday(as.Date(time_hour)) == 7,1,0) ## Creating categorical variable for weekend-ness
         ,diff_20hr  = if_else(sched_dep_time < 2000, 1960 - sched_dep_time, sched_dep_time - 2000) ## Transforming time variable by difference from 8 p.m.
         ,diff_7mo   = abs(month.x-7)) %>%  ## Transforming month variable by difference from July
  ungroup() %>%
  group_by(origin) %>%
  mutate(ogn_delay = mean(dep_delay,na.rm = T) - mean(flights$dep_delay, na.rm = T)) %>% ## Deriving origin effect
  ungroup() %>%
  select(dep_delay, temp:ogn_delay)

flt_wx_cln
```
## Bivariate analysis

There are steps here

1. Scatter plots to intuit relationships to explore
2. Box plots to see if outliers may be skewing things
3. Find correlation
4. Linear model the best



```{r}
flt_wx_cln %>%
  group_by(temp) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = temp, y = mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Temp appears to have a relationship albeit weak')

flt_wx_cln %>%
  group_by(dewp) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = dewp, y = mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Dewpoint looks real similar to temp which makes sense')

flt_wx_cln %>%
  group_by(humid) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = humid, y = mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Humidity is the best so far but still weak')

flt_wx_cln %>%
  group_by(wind_speed) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = wind_speed, mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Std dev increases as wind speed increases BAD')

flt_wx_cln %>%
  group_by(wind_gust) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = wind_gust, mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Wind gust is weak')

flt_wx_cln %>%
  group_by(precip) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = precip, mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Precipitation looks OK')

flt_wx_cln %>%
  group_by(pressure) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = pressure, mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Pressure looks pretty decent')

flt_wx_cln %>%
  group_by(visib) %>%
  summarise(mean_delay = mean(dep_delay, na.rm = T)) %>%
ggplot(aes(x = visib, mean_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Visibility is on the good side of OK')

flt_wx_cln %>%
ggplot(aes(x = carr_delay, dep_delay)) +
  geom_point() +
  geom_smooth(method = lm, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Carrier effect graphs poorly but could be nice')

flt_wx_cln %>%
ggplot(aes(x = jitter(is_wkend, 0.8), jitter(dep_delay,10))) +
  geom_point() +
  geom_smooth(method = loess, se = F) +
  theme_fivethirtyeight() +
  scale_color_fivethirtyeight() +
  ggtitle('Weekend day also graphs poorly')

flt_wx_cln %>%
  cor(use = 'pairwise.complete.obs', method = 'pearson') %>%
  round(2) %>%
  as.data.frame() %>%
  select(1) %>%
  cbind(rownames(.),.) %>%
  filter(dep_delay > -1 & dep_delay < 1) %>%
  arrange(desc(abs(dep_delay)))

# ASCII bits for building in-line histograms
# 0| |▁
# 1|▂|▃
# 2|▄|▅
# 3|▆|▇
# 4|█|

```



## Multivariate analysis

1. Covariance
2. Linear model multiple



